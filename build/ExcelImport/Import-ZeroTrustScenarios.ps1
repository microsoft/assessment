<#
.SYNOPSIS
    Reads Zero Trust scenarios from Excel and generates corresponding C# code to represent scenarios.
.DESCRIPTION
    This cmdlet assumes the file ZeroTrust config file 'Zero Trust Scenarios_ForWizards_UseThisCopy.xlsx' 
    stored in the ZT Advisory V-Team SharePoint site has been synced to the local device where this script is running.
    Run the script to import the latest wording from the config file to a .cs file.
    The .cs file needs to include a region with the following name.
    #region AutoGeneratedZeroTrustDataFromExcel

    The generated code will be 
    Requires module
    * Install-Module ImportExcel

.EXAMPLE
    PS C:\> Import-ZeroTrustScenarios 
        -ExcelPath 'F:\OneDrive\Zero Trust Scenarios_ForWizards_UseThisCopy.xlsx'
        -SrcPath 'F:\Code\msassessment\src\Assessment\Assessment.Shared\ZeroTrust\ZeroTrustDataService.cs'    
#>

param (
    # Location of the Zero Trust Scenarios excel file. e.g. 'F:\OneDrive\Zero Trust Scenarios_ForWizards_UseThisCopy.xlsx'
    [Parameter(Mandatory = $true)]
    [string] $ExcelPath,

    # Location of the .cs file where the generated code will be inserted.
    [Parameter(Mandatory = $true)]
    [string] $SrcPath
)

# Removes new line characters and returns the first line in the cell.
function GetFirstLine($text) {
    if ($text) {
        $arr = $text -split "`n"
        foreach ($line in $arr) {
            if (![string]::IsNullOrEmpty($line)) {
                return $line.Trim()
            }
        }
        return $text.Trim()    
    }
    else {
        return $text
    }
}
Import-Module ImportExcel

$ztScenarios = Import-Excel $ExcelPath -WorksheetName "Wizards- Foundational Scenarios" -Raw -StartRow 2

$code = '        #region AutoGeneratedZeroTrustDataFromExcel';
foreach ($item in $ztScenarios) {
    $bs = GetFirstLine $item.'Business Scenario'
    if (![string]::IsNullOrEmpty($bs)) {
        $code += "            bs = new ZeroTrustBusinessScenario() { Name = `"$bs`" }; zeroTrustData.BusinessScenarios.Add(bs);`n"
    }
    $ts = GetFirstLine $item.'Technical Scenario'
    if (![string]::IsNullOrEmpty($ts)) {
        $code += "            ts = new ZeroTrustTechnicalScenario() { Name = `"$ts`" }; bs.TechnicalScenarios.Add(ts);`n"
    }
    $r = GetFirstLine $item.'M365 Controls / IT Actions'
    if (![string]::IsNullOrEmpty($r)) {
        $className = $item.ZTAssessClass
        $code += "            r = new ZeroTrustRecommendation() { Name = `"$ts`", ClassName = `"$className`" }; ts.Recommendations.Add(r);`n"
    }
    $c = GetFirstLine $item.'Sub Tasks'
    $checkId = $item.'Name in ZT Asssessment Tool'
    if (![string]::IsNullOrEmpty($c) -and ($checkId -ne 'Ignore')) {
        $className = $checkId #TODO Lookup folder for classname
        $license = $item.'License Required'
        $productName = $item.'Product Name'
        $ztPrincipal = $item.'Zero Trust Principal'
        $code += "            c = new ZeroTrustCheck() { Id = `"$checkId`", Name = `"$c`", License = `"$license`", ProductName = `"$productName`", ZeroTrustPrincipal = `"$ztPrincipal`" }; r.Checks.Add(c);`n"
    }

    
}
$code += '        #endregion';
$code